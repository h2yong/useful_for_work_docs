= 准备封装环境和母盘安装
:stem: latexmath
:icons: font
:source-highlighter: highlight.js
:sectnums:
:sectlinks:
:sectnumlevels: 4
:toc: left
:toc-title: 目录
:toclevels: 4

== 制作一个用于封装的优启通PE镜像
下载link:https://www.itsk.com/thread/434043[优启通]后，打开优启通后``EasyU_v3.7.exe``，按照下图步骤制作ISO镜像。
image:images/制作优启通PE镜像文件.png[align=center]

== 安装link:https://www.ghxi.com/workstationlite.html[VMware-workstation-16]
下载link:https://www.ghxi.com/workstationlite.html[VMware-workstation-16]后，打开link:https://www.ghxi.com/workstationlite.html[VMware-workstation-16]安装包，依次点击下一步即可完成安装。

== 创建一个适合封装WIN10 64位系统的虚拟机环境
. 按照下图步骤初步设置好虚拟机Windows10系统的配置。
image:images/新建虚拟机环境.png[align=center]
. 进入自定义硬件界面，删掉不必要的4个硬件(为了防止一安装完母盘就直接联网，网络适配器一定要暂时移除，需要的时候我们再将其添加进来)。
image:images/删除设备.png[align=center]

[#虚拟机BIOS设置]
== 虚拟机BIOS设置
. 如下图，点击三角形旁边的下拉三角形选择打开电源时进入固件进入虚拟机BIOS。
image:images/进入虚拟机BIOS.png[align=center]
. 进入BIOS设置, 定位到Advanced的I/O设置。
image:images/定位到Advanced的IO设置.png[align=center]
. 全部改为Disabled关掉不必要的东西，减少不必要的影响。
image:images/Disabled关掉不必要的东西.png[align=center]
. 按“＋”加号和“－”减号调上下来更改启动项(或者SHIFT键+“＋”加号, Fn键+“－”减号)，使CD-ROM Drive为第一启动项，+Hard Drive为第二启动项。
image:images/修改第一启动项.png[align=center]
. 设置完成后按F10保存退出。
image:images/按F10保存退出.png[align=center]

== 虚拟机分区
. <<虚拟机BIOS设置>>步骤之后进入windows boot manager，迅速选择``[2] Windows 10 PE x64``，这里只有5s等待时间。
image:images/选择Windows 10 PE x64.png[align=center]
. 进入桌面后，打开``DG硬盘分区``工具，以MBR硬盘格式快速分成2个分区，这里C盘系统盘设置为35G，D盘为数据盘设置为25G，并记得4K对齐。
image:images/打开DG硬盘分区.png[align=center]
image:images/快速分2个区.png[align=center]
. 检查一下分区是否正确，如果盘符有问题，重启后即可恢复正常。
image:images/检查分区.png[align=center]
. 关闭虚拟机PE系统。

== 磁盘映射
. 分区完成后关闭虚拟机PE系统, 准备虚拟机磁盘映射. +
--
TIP: 映射磁盘必须在关机的情况下才能打开磁盘映射，而且每次要准备虚拟机磁盘映射前都要先进入PE一次，然后关机后才能操作磁盘映射。这样是为了避免出现复制进虚拟机磁盘里的文件有时候会消失，或者文件夹打不开，报错等情况.这里将虚拟机的D盘，映射为实体机的Z盘。记得把以只读方式打开文件前面的勾去掉。

image:images/磁盘映射.png[align=center]
--

== 复制下面的软件以及精简后的母盘至Z盘(虚拟机D盘)
TIP: 请提前将软件下载到本地。

* link:https://www.itsk.com/thread-396895-1-1.html[GoRuntime_DirectX_9.0c运行库]
* link:https://www.ghxi.com/yxkhj.html[微软常用运行库合集]
* link:https://www.7-zip.org/[7zip]
** windows11可替换为link:https://github.com/M2Team/NanaZip/releases[nanazip]
* link:https://www.yrxitong.com/h-nd-1030.html[Office2021]
* link:https://www.yrxitong.com/h-nd-122.html[软媒清理大师单文件版3.7.8.0]
* link:https://github.com/zbezj/HEU_KMS_Activator/releases[系统和Office激活工具HEU_KMS_Activator]
* link:https://www.itsk.com/thread/434330[Easy Sysprep]
* link:https://www.itsk.com/thread/434532[万能驱动]
* link:https://github.com/Chuyu-Team/Dism-Multi-language/releases[Dism-Multi-language]
* link:https://www.yrxitong.com/h-nd-100.html[小鱼儿yr系统封装优化设置辅助工具]

复制完成后记得关闭所有文件夹(包含Everything类似工具也需要关闭)，然后才点断开连接，不然无法断开虚拟机磁盘映射，没有断开磁盘映射就无法开启虚拟机，就会报错。
image:images/断开连接.png[align=center]

== 母盘安装
. 开启虚拟机，进入PE后打开桌面上的EIX系统安装工具，可以看到EIX已经自动搜索到虚拟机数据盘D盘的windows10镜像文件，按照下图运行EIX2进行映像恢复，左边选待恢复的母盘映像，右边选系统盘C盘。
image:images/恢复镜像.png[align=center]
. 镜像恢复后重启虚拟机，到达系统安装设置界面后, 直接按Ctrl+Shift+F3(有些笔记本需要按住Fn+ Ctrl+Shift+F3)进入审核模式。
image:images/审核模式.png[align=center]
. 如图进入桌面后会弹出系统准备工具3.14窗口，表面已经进入了审核模式，每次重启它都会弹出，关闭即可。
image:images/Sysprep的对话框.png[align=center]

== 参考教程
* https://www.itsk.com/thread/408641[Windows 10 Enterprise LTSC 2019_x64极度精简超详细ES5封装过程(二、封装准备)]
* https://www.yrxitong.com/h-nd-1102.html[2022年全新Windows11系统封装图文教程(二)准备系统封装环境]